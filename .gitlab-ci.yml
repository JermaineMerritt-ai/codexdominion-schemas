stages:
  - reset

safe_reset:
  stage: reset
  script:
    - echo "=== SAFE RESET & REBUILD START ==="
    - echo "üßπ Cleaning Node.js environment..."
    - rm -rf node_modules package-lock.json
    - npm cache clean --force
    - npm install
    - echo "‚úÖ Node.js reset complete"
    - echo "üßπ Cleaning Python environment..."
    - find . -type d -name "__pycache__" -exec rm -r {} + || true
    - find . -name "*.pyc" -delete || true
    - rm -rf venv .venv
    - python3 -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - echo "‚úÖ Python reset complete"
    - echo "üßπ Cleaning Java build..."
    - |
      if [ -f "pom.xml" ]; then
        mvn clean install
      elif [ -f "build.gradle" ]; then
        gradle clean build
      else
        echo "‚ö†Ô∏è No Java build files found, skipping"
      fi
    - echo "‚úÖ Java reset complete"
    - echo "üîÑ Refreshing CodexDominion schemas..."
    - mkdir -p schema_backup
    - cp -r schemas/* schema_backup/ || true
    - cp -r schema_templates/* schemas/ || true
    - echo "‚úÖ Schema refresh complete"
    - echo "=== SAFE RESET & REBUILD COMPLETE ==="
  artifacts:
    paths:
      - node_modules/
      - venv/
      - schema_backup/
    expire_in: 1 week
  only:
    - main
    - develop
  when: manual
