# Codex Dominion - WebSocket Chat Server Dockerfile

FROM python:3.12-slim

WORKDIR /app

RUN pip install --no-cache-dir \
    websockets==12.0 \
    asyncio

# Create WebSocket server
RUN echo 'import asyncio\n\
import websockets\n\
import json\n\
from datetime import datetime\n\
\n\
connected_clients = set()\n\
\n\
async def handle_client(websocket, path):\n\
    connected_clients.add(websocket)\n\
    print(f"Client connected. Total: {len(connected_clients)}")\n\
    try:\n\
        async for message in websocket:\n\
            data = json.loads(message)\n\
            data["timestamp"] = datetime.utcnow().isoformat()\n\
            response = json.dumps(data)\n\
            await asyncio.gather(\n\
                *[client.send(response) for client in connected_clients if client != websocket],\n\
                return_exceptions=True\n\
            )\n\
    except websockets.exceptions.ConnectionClosed:\n\
        pass\n\
    finally:\n\
        connected_clients.remove(websocket)\n\
        print(f"Client disconnected. Total: {len(connected_clients)}")\n\
\n\
async def main():\n\
    print("ðŸ”Œ WebSocket Chat Server starting on port 8765...")\n\
    async with websockets.serve(handle_client, "0.0.0.0", 8765):\n\
        await asyncio.Future()\n\
\n\
if __name__ == "__main__":\n\
    asyncio.run(main())' > chat_server.py

EXPOSE 8765

CMD ["python", "chat_server.py"]
