name: ğŸŒ Multi-Cloud Deployment Pipeline

on:
  push:
    branches: [main, production]
  workflow_dispatch:
    inputs:
      target:
        description: 'Deployment target'
        required: true
        type: choice
        options:
          - all
          - ionos
          - azure
          - github-packages
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - production
          - staging

env:
  DOCKER_REGISTRY: ghcr.io
  DOCKER_USERNAME: ${{ github.actor }}
  IONOS_SERVER: 74.208.123.158
  AZURE_RESOURCE_GROUP: codex-dominion-rg
  AZURE_CLUSTER_NAME: codex-dominion-aks
  DOMAIN: codexdominion.app

jobs:
  # ============================================
  # Job 1: Build & Test
  # ============================================
  build-and-test:
    name: ğŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Generate Version Tag
        id: version
        run: |
          VERSION="v$(date +%Y%m%d)-${GITHUB_SHA::7}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Version: $VERSION"

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ”§ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci
          pip install -r requirements.txt || true

      - name: ğŸ§ª Run Tests
        run: |
          npm test || echo "âš ï¸ No tests configured"
          pytest tests/ || echo "âš ï¸ No Python tests found"

      - name: ğŸ“Š TypeScript Type Check
        run: |
          npm run type-check || tsc --noEmit || echo "âš ï¸ Type check skipped"

      - name: ğŸ” Lint Code
        run: |
          npm run lint || echo "âš ï¸ Linting skipped"

  # ============================================
  # Job 2: Build Docker Images
  # ============================================
  build-docker-images:
    name: ğŸ³ Build Docker Images
    runs-on: ubuntu-latest
    needs: build-and-test
    strategy:
      matrix:
        service:
          - name: jermaine-super-action-ai
            dockerfile: Dockerfile.jermaine
            context: .
          - name: dot300-action-ai
            dockerfile: Dockerfile.dot300
            context: .
          - name: avatar-system
            dockerfile: Dockerfile.avatar
            context: .
          - name: codex-dashboard
            dockerfile: Dockerfile
            context: .

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ—ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ³ Build and Push ${{ matrix.service.name }}
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.context }}
          file: ${{ matrix.service.dockerfile }}
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ github.repository }}/${{ matrix.service.name }}:${{ needs.build-and-test.outputs.version }}
            ${{ env.DOCKER_REGISTRY }}/${{ github.repository }}/${{ matrix.service.name }}:latest
            jmerritt48/${{ matrix.service.name }}:${{ needs.build-and-test.outputs.version }}
            jmerritt48/${{ matrix.service.name }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

  # ============================================
  # Job 3: Deploy to IONOS
  # ============================================
  deploy-ionos:
    name: ğŸŸ¦ Deploy to IONOS
    runs-on: ubuntu-latest
    needs: [build-and-test, build-docker-images]
    if: |
      github.event.inputs.target == 'all' ||
      github.event.inputs.target == 'ionos' ||
      github.event.inputs.target == '' && github.ref == 'refs/heads/main'
    environment:
      name: ionos-production
      url: https://dashboard.codexdominion.app

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Setup SSH Key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.IONOS_SSH_KEY }}

      - name: ğŸ“¦ Create Deployment Package
        run: |
          tar -czf deployment.tar.gz \
            docker-compose.production.yml \
            nginx/ \
            k8s/ \
            scripts/ \
            --exclude='*.md' \
            --exclude='node_modules' \
            --exclude='.git'

      - name: ğŸ“¤ Upload to IONOS Server
        run: |
          scp -o StrictHostKeyChecking=no \
            deployment.tar.gz \
            root@${{ env.IONOS_SERVER }}:/tmp/

      - name: ğŸš€ Deploy on IONOS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.IONOS_SERVER }}
          username: root
          key: ${{ secrets.IONOS_SSH_KEY }}
          script: |
            set -e

            echo "ğŸ”¥ IONOS Deployment Started"
            cd /var/www/codexdominion

            # Backup current deployment
            echo "ğŸ’¾ Creating backup..."
            tar -czf backup-$(date +%Y%m%d-%H%M%S).tar.gz ./* || true

            # Extract new deployment
            echo "ğŸ“¦ Extracting deployment package..."
            tar -xzf /tmp/deployment.tar.gz
            rm /tmp/deployment.tar.gz

            # Pull latest images
            echo "ğŸ³ Pulling Docker images..."
            docker-compose -f docker-compose.production.yml pull

            # Restart services
            echo "ğŸ”„ Restarting services..."
            docker-compose -f docker-compose.production.yml up -d --remove-orphans

            # Cleanup old images
            echo "ğŸ§¹ Cleanup..."
            docker system prune -af --volumes

            # Health check
            echo "ğŸ¥ Health check..."
            sleep 10
            curl -f http://localhost/health || echo "âš ï¸ Health check warning"

            echo "âœ… IONOS Deployment Complete!"

      - name: ğŸŒ Update Nginx Configuration
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.IONOS_SERVER }}
          username: root
          key: ${{ secrets.IONOS_SSH_KEY }}
          script: |
            # Test nginx configuration
            nginx -t

            # Reload nginx
            systemctl reload nginx

            echo "âœ… Nginx reloaded"

  # ============================================
  # Job 4: Deploy to Azure AKS
  # ============================================
  deploy-azure:
    name: â˜ï¸ Deploy to Azure AKS
    runs-on: ubuntu-latest
    needs: [build-and-test, build-docker-images]
    if: |
      github.event.inputs.target == 'all' ||
      github.event.inputs.target == 'azure' ||
      github.event.inputs.target == '' && github.ref == 'refs/heads/main'
    environment:
      name: azure-production
      url: https://jermaine-ai.codexdominion.app

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ”§ Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.32.0'

      - name: ğŸ”— Get AKS Credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AZURE_CLUSTER_NAME }} \
            --overwrite-existing

      - name: ğŸ·ï¸ Update Image Tags
        run: |
          VERSION="${{ needs.build-and-test.outputs.version }}"

          # Update Kubernetes manifests with new image tags
          sed -i "s|image: jmerritt48/jermaine-super-action-ai:.*|image: jmerritt48/jermaine-super-action-ai:${VERSION}|g" k8s/ai-systems-deployment.yaml
          sed -i "s|image: jmerritt48/dot300-action-ai:.*|image: jmerritt48/dot300-action-ai:${VERSION}|g" k8s/ai-systems-deployment.yaml
          sed -i "s|image: jmerritt48/avatar-system:.*|image: jmerritt48/avatar-system:${VERSION}|g" k8s/ai-systems-deployment.yaml

      - name: ğŸš€ Deploy to AKS
        run: |
          echo "ğŸš€ Deploying to Azure AKS..."

          # Apply configurations
          kubectl apply -f k8s/namespaces.yaml || true
          kubectl apply -f k8s/configmaps.yaml || true
          kubectl apply -f k8s/secrets.yaml || true

          # Deploy AI systems
          kubectl apply -f k8s/ai-systems-deployment.yaml
          kubectl apply -f k8s/ai-systems-ingress.yaml

          # Deploy engines
          kubectl apply -f k8s/engines-complete.yaml

          # Wait for rollout
          echo "â³ Waiting for rollout..."
          kubectl rollout status deployment/jermaine-super-action-ai -n codex-governance --timeout=5m
          kubectl rollout status deployment/dot300-action-ai -n codex-governance --timeout=5m
          kubectl rollout status deployment/avatar-system -n codex-governance --timeout=5m

      - name: ğŸ¥ Health Check
        run: |
          echo "ğŸ¥ Performing health checks..."

          # Check pod status
          kubectl get pods -n codex-governance
          kubectl get pods -n default | grep engine

          # Check services
          kubectl get services -n codex-governance

          # Check ingress
          kubectl get ingress -n codex-governance

          echo "âœ… Azure AKS Deployment Complete!"

  # ============================================
  # Job 5: Update DNS & SSL
  # ============================================
  update-dns-ssl:
    name: ğŸŒ Update DNS & SSL
    runs-on: ubuntu-latest
    needs: [deploy-ionos, deploy-azure]
    if: always() && (needs.deploy-ionos.result == 'success' || needs.deploy-azure.result == 'success')

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Setup SSH for IONOS
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.IONOS_SSH_KEY }}

      - name: ğŸ”’ Renew SSL Certificates (IONOS)
        if: needs.deploy-ionos.result == 'success'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.IONOS_SERVER }}
          username: root
          key: ${{ secrets.IONOS_SSH_KEY }}
          script: |
            echo "ğŸ”’ Checking SSL certificates..."
            certbot renew --quiet --nginx
            echo "âœ… SSL certificates updated"

      - name: ğŸ”’ Check SSL (Azure)
        if: needs.deploy-azure.result == 'success'
        run: |
          echo "ğŸ”’ Checking Azure SSL certificates..."
          kubectl get certificate -n codex-governance
          echo "âœ… Azure cert-manager handling SSL"

      - name: ğŸ“Š DNS Propagation Check
        run: |
          echo "ğŸ“Š Checking DNS propagation..."

          nslookup codexdominion.app 8.8.8.8 || echo "âš ï¸ DNS not propagated"
          nslookup jermaine-ai.codexdominion.app 8.8.8.8 || echo "âš ï¸ Subdomain DNS not propagated"

  # ============================================
  # Job 6: Integration Tests
  # ============================================
  integration-tests:
    name: ğŸ§ª Integration Tests
    runs-on: ubuntu-latest
    needs: [deploy-ionos, deploy-azure]
    if: always() && (needs.deploy-ionos.result == 'success' || needs.deploy-azure.result == 'success')

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ§ª Test IONOS Endpoints
        if: needs.deploy-ionos.result == 'success'
        run: |
          echo "ğŸ§ª Testing IONOS endpoints..."

          # Test direct IP
          curl -f http://${{ env.IONOS_SERVER }}/health || echo "âš ï¸ Direct IP health check failed"

          # Test domain (when DNS propagates)
          curl -f https://dashboard.codexdominion.app/health || echo "âš ï¸ Domain health check pending"

      - name: ğŸ§ª Test Azure Endpoints
        if: needs.deploy-azure.result == 'success'
        run: |
          echo "ğŸ§ª Testing Azure endpoints..."

          # Get LoadBalancer IP
          kubectl get service ai-systems-coordinator -n codex-governance -o jsonpath='{.status.loadBalancer.ingress[0].ip}'

          # Test pods
          kubectl get pods -n codex-governance

      - name: ğŸ“Š Generate Test Report
        if: always()
        run: |
          echo "ğŸ“Š Deployment Test Report"
          echo "========================="
          echo "IONOS: ${{ needs.deploy-ionos.result }}"
          echo "Azure: ${{ needs.deploy-azure.result }}"
          echo "Timestamp: $(date -u)"

  # ============================================
  # Job 7: Notification
  # ============================================
  notify:
    name: ğŸ“¢ Send Notification
    runs-on: ubuntu-latest
    needs: [deploy-ionos, deploy-azure, integration-tests]
    if: always()

    steps:
      - name: ğŸ“Š Deployment Summary
        run: |
          echo "ğŸš€ MULTI-CLOUD DEPLOYMENT SUMMARY"
          echo "=================================="
          echo ""
          echo "ğŸŸ¦ IONOS:  ${{ needs.deploy-ionos.result }}"
          echo "â˜ï¸  Azure:  ${{ needs.deploy-azure.result }}"
          echo "ğŸ§ª Tests:  ${{ needs.integration-tests.result }}"
          echo ""
          echo "ğŸŒ URLs:"
          echo "  - https://codexdominion.app"
          echo "  - https://dashboard.codexdominion.app"
          echo "  - https://jermaine-ai.codexdominion.app"
          echo "  - https://dot300-ai.codexdominion.app"
          echo "  - https://avatar.codexdominion.app"
          echo ""
          echo "ğŸ“¦ Version: ${{ needs.build-and-test.outputs.version }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
