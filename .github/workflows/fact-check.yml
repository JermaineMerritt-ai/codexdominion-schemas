name: Fact Check (PR Gate)
on:
  pull_request:
    paths:
      - content/**
      - markets/**
      - academy/**
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          pip install -r services/fact-check-tools/requirements.txt
      - name: Run fact-check validators
        run: |
          python services/fact-check-tools/validate_sources.py | tee validate_sources.log
          python services/fact-check-tools/check_math_units.py | tee check_math_units.log
          python services/fact-check-tools/parity_check.py | tee parity_check.log
      - name: Upload validation logs
        uses: actions/upload-artifact@v4
        with:
          name: factcheck-logs
          path: |
            validate_sources.log
            check_math_units.log
            parity_check.log
      - name: Install validators
        run: |
          pip install -q validators requests python-dateutil
          npm ci --prefix .tools/factcheck

      - name: Validate sources & URLs
        run: python .tools/factcheck/validate_sources.py content/ --min-sources 2

      - name: Check math & units
        run: python .tools/factcheck/check_math_units.py content/

      - name: Finance parity (tickers, dates, prices)
        run: python markets/tools/parity_check.py --apis alpha_vantage,polygon --strict

      - name: Evidence schema validation
        run: node .tools/factcheck/validate_evidence.js content/**/*.evidence.json

      # All previous steps will block the PR if any validation fails. No need for a separate block step.
