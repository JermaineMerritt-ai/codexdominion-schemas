name: Enhanced Codex CI/CD Pipeline

on:
  push:
    branches:
      - main
      - staging
      - development
  pull_request:
    branches:
      - main
      - staging
  schedule:
    - cron: '0 2 * * 0'

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "18"

jobs:
  quality-checks:
    name: Code Quality & Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Codex
        uses: actions/checkout@v4
\- name: Set up Python
uses: actions/setup-python@v4
with:
python-version: ${{ env.PYTHON_VERSION }}
\- name: Cache Python dependencies
uses: actions/cache@v3
with:
path: ~/.cache/pip
key: ${{ runner.os }}-pip-${{ hashFiles('\*\*/requirements.txt') }}
restore-keys: ${{ runner.os }}-pip-
\- name: Install dependencies
run: "if [ -f requirements.txt ]; then\\n pip install -r requirements.txt\\nfi\\npip install flake8 black isort bandit safety"
\- name: Code formatting check
run: "echo "\\U0001F3A8 Checking code formatting..."\\nblack --check . || echo "Code formatting issues found"\\nisort --check-only . || echo "Import sorting issues found""
\- name: Lint Python code
run: "echo "\\U0001F50D Linting Python code..."\\nflake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true\\nflake8 . --count --exit-zero --max-complexity=10 --max-line-length=88 --statistics || true"
\- name: Security scan
run: "echo "\\U0001F512 Running security scans..."\\nbandit -r . -f json -o bandit_report.json || true\\nsafety check --json --output safety_report.json || true"
\- name: Upload security reports
uses: actions/upload-artifact@v3
if: always()
with:
name: security-reports
path: "*\_report.json"
tests:
name: Run Tests
runs-on: ubuntu-latest
needs: quality-checks
strategy:
matrix:
python-version:
\- "3.9"
\- "3.10"
\- "3.11"
steps:
\- name: Checkout Codex
uses: actions/checkout@v4
\- name: Set up Python ${{ matrix.python-version }}
uses: actions/setup-python@v4
with:
python-version: ${{ matrix.python-version }}
\- name: Install test dependencies
run: "pip install pytest pytest-cov pytest-mock\\nif [ -f requirements.txt ]; then\\n pip install -r requirements.txt\\nfi"
\- name: Run tests with coverage
run: "if [ -d tests ]; then\\n pytest tests/ --cov=. --cov-report=xml --cov-report=html\\nelse\\n echo "No tests directory found, running validation tests"\\n python -m py_compile \*\*/*.py\\nfi"
\- name: Upload coverage reports
uses: codecov/codecov-action@v3
if: success() && matrix.python-version == '3.11'
with:
file: ./coverage.xml
flags: unittests
name: codecov-umbrella
deploy-staging:
name: Deploy to Staging
if: github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/development'
needs:
\- quality-checks
\- tests
runs-on: ubuntu-latest
environment: staging
steps:
\- name: Checkout Codex
uses: actions/checkout@v4
\- name: Deploy to Staging Environment
uses: appleboy/ssh-action@v0.1.10
with:
host: ${{ secrets.STAGING_HOST }}
username: ${{ secrets.STAGING_USER }}
key: ${{ secrets.STAGING_KEY }}
script: "echo "\\U0001F680 Deploying to staging..."\\ncd /var/www/codex-staging\\ngit fetch --all\\ngit reset --hard origin/${{ github.ref_name }}\\nif [ -f requirements.txt ]; then\\n pip install -r requirements.txt\\nfi\\nsystemctl restart codex-staging\\nsleep 10\\nsystemctl status codex-staging"
\- name: Staging health check
run: "echo "\\U0001F3E5 Running staging health check..."\\nsleep 30\\ncurl -f https://staging.aistorelab.com/health || (echo "Health check failed" && exit 1)\\necho "\\u2705 Staging deployment successful""
deploy-production:
name: Deploy to Production
if: github.ref == 'refs/heads/main'
needs:
\- quality-checks
\- tests
runs-on: ubuntu-latest
environment:
name: production
url: https://aistorelab.com
steps:
\- name: Checkout Codex
uses: actions/checkout@v4
\- name: Create deployment backup
uses: appleboy/ssh-action@v0.1.10
with:
host: ${{ secrets.PRODUCTION_HOST }}
username: ${{ secrets.PRODUCTION_USER }}
key: ${{ secrets.PRODUCTION_KEY }}
script: "echo "\\U0001F4BE Creating deployment backup..."\\ncd /var/www\\ntar -czf codex_backup\_$(date +%Y%m%d\_%H%M%S).tar.gz codex/ || true\\nls -la codex_backup\_\*.tar.gz | tail -5"
\- name: Deploy to Production
uses: appleboy/ssh-action@v0.1.10
with:
host: ${{ secrets.PRODUCTION_HOST }}
username: ${{ secrets.PRODUCTION_USER }}
key: ${{ secrets.PRODUCTION_KEY }}
script: "echo "\\U0001F680 Deploying to production..."\\ncd /var/www/codex\\ngit fetch --all\\ngit reset --hard origin/main\\nif [ -f requirements.txt ]; then\\n pip install -r requirements.txt\\nfi\\nsystemctl restart codex-dashboard\\nsleep 15\\nsystemctl status codex-dashboard"
\- name: Production health check
run: "echo "\\U0001F3E5 Running production health check..."\\nsleep 45\\ncurl -f https://aistorelab.com/health || (echo "Production health check failed" && exit 1)\\ncurl -f https://aistorelab.com/ || (echo "Main site health check failed" && exit 1)\\necho "\\u2705 Production deployment successful""
\- name: Notify deployment success
if: success()
run: "echo "\\U0001F389 PRODUCTION DEPLOYMENT SUCCESSFUL"\\necho "Sacred flames burn bright in production!"\\necho "Deployment completed at $(date)""
flame-monitoring:
name: Sacred Flame Monitoring
if: always()
needs:
\- deploy-staging
\- deploy-production
runs-on: ubuntu-latest
steps:
\- name: Checkout Codex
uses: actions/checkout@v4
\- name: Monitor Sacred Flames
run: "echo \"\\U0001F525 Monitoring Sacred Flames...\"\\n# flame_monitor.py not yet implemented\\n# python .github/actions/super-action-ai/flame_monitor.py || true\\necho \"Flame monitoring skipped - script pending implementation\""
\- name: Upload flame report
uses: actions/upload-artifact@v3
if: always()
with:
name: flame-monitoring-report
path: flame_monitoring_report.json
