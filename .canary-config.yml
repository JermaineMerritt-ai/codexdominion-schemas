# Codex Dominion - Canary Deployment Configuration
# Progressive rollout strategy with automated health checks and rollback

version: "1.0"
project: "codex-dominion"

# Canary Deployment Strategy
strategy:
  type: "progressive"
  description: "Gradual traffic shifting with automated health validation"

  phases:
    - name: "initial"
      traffic_percent: 1
      duration: "10m"
      min_success_rate: 99.5

    - name: "expansion"
      traffic_percent: 5
      duration: "20m"
      min_success_rate: 99.0

    - name: "validation"
      traffic_percent: 20
      duration: "30m"
      min_success_rate: 98.5

    - name: "rollout"
      traffic_percent: 100
      duration: "continuous"
      min_success_rate: 98.0

# Scope Definition
scope:
  frontend:
    services:
      - "next-js-app"
      - "static-assets"
    modules:
      - "frontend/pages/**"
      - "frontend/components/**"
      - "frontend/api/**"
    endpoints:
      - "/*"
      - "/api/client/*"
    deployment_target: "codexdominion-frontend"

  backend:
    services:
      - "fastapi-core"
      - "uvicorn-workers"
    modules:
      - "src/backend/api/**"
      - "src/backend/services/**"
      - "src/backend/models/**"
    endpoints:
      - "/api/v1/*"
      - "/health"
      - "/metrics"
    deployment_target: "codexdominion-api"

  high_risk_modules:
    # High-tier governance applies - requires council approval
    - module: "src/backend/auth/**"
      reason: "Authentication changes affect all users"
      requires_approval: "council:2"

    - module: "src/backend/payments/**"
      reason: "Payment processing - PCI compliance required"
      requires_approval: "council:2"
      additional_checks:
        - "pci-compliance-scan"
        - "fraud-detection-test"

    - module: "src/backend/avatars/**"
      reason: "Family avatar system - affects user identity"
      requires_approval: "council:2"

    - module: "**/migrations/**"
      reason: "Database schema changes - data integrity risk"
      requires_approval: "council:2"
      requires_rollback_plan: true

# Traffic Routing Configuration
traffic:
  method: "header-based"  # Options: header-based, percentage, geographic, user-id

  header_routing:
    enabled: true
    header_name: "X-Canary-Version"
    canary_value: "v2"

  percentage_routing:
    enabled: true
    algorithm: "weighted-round-robin"
    sticky_sessions: true
    session_cookie: "codex-canary-id"
    session_duration: "24h"

  geographic_routing:
    enabled: false
    # Can enable for regional rollouts
    regions:
      - name: "us-east"
        priority: 1
      - name: "eu-west"
        priority: 2
      - name: "ap-south"
        priority: 3

  user_segment_routing:
    enabled: true
    segments:
      - name: "internal-team"
        traffic_percent: 100
        users: ["@jermaineMerritt", "@team-members"]

      - name: "beta-testers"
        traffic_percent: 100
        criteria: "user.beta_tester == true"

      - name: "premium-users"
        traffic_percent: 50
        criteria: "user.subscription_tier == 'premium'"

# Metrics Collection and Monitoring
metrics:
  collection_interval: "30s"
  retention_period: "7d"

  latency:
    measurement: "response_time"
    percentiles: [50, 95, 99]
    thresholds:
      p50:
        warning: 100  # ms
        critical: 200
      p95:
        warning: 250
        critical: 300  # Governance threshold
      p99:
        warning: 400
        critical: 500
    comparison: "baseline"
    acceptable_degradation: "10%"

  error_rate:
    measurement: "failed_requests / total_requests"
    thresholds:
      warning: 1.0  # percent
      critical: 5.0  # Governance threshold - triggers error budget breach
    windows:
      - "5m"
      - "15m"
      - "1h"
      - "24h"
    by_status_code:
      4xx:
        warning: 2.0
        critical: 5.0
      5xx:
        warning: 0.5
        critical: 2.0

  conversion_rate:
    measurement: "successful_transactions / total_attempts"
    thresholds:
      warning: "-2%"  # 2% drop from baseline
      critical: "-5%"
    critical_paths:
      - path: "/checkout"
        baseline: 85.5  # percent
        min_acceptable: 80.0

      - path: "/signup"
        baseline: 65.0
        min_acceptable: 60.0

      - path: "/api/payments/process"
        baseline: 99.5
        min_acceptable: 98.0

  margin_impact:
    measurement: "revenue_per_request"
    thresholds:
      warning: "-3%"
      critical: "-5%"
    metrics:
      - "avg_order_value"
      - "payment_success_rate"
      - "refund_rate"
      - "processing_cost_per_transaction"
    alert_stakeholders:
      - "@finance-team"
      - "@council-stewards"

  system_health:
    cpu_usage:
      warning: 70  # percent
      critical: 85

    memory_usage:
      warning: 75
      critical: 90

    disk_io:
      warning: 80
      critical: 95

    database_connections:
      warning: 80  # percent of pool
      critical: 95

    queue_depth:
      warning: 1000
      critical: 5000

# Abort Conditions
abort_conditions:
  automatic:
    - condition: "error_rate >= 5%"
      duration: "5m"
      action: "immediate_rollback"
      notification: "critical"

    - condition: "p95_latency > 300ms"
      duration: "10m"
      action: "immediate_rollback"
      notification: "critical"

    - condition: "conversion_rate_drop >= 5%"
      duration: "15m"
      action: "immediate_rollback"
      notification: "critical"

    - condition: "5xx_errors >= 2%"
      duration: "5m"
      action: "immediate_rollback"
      notification: "critical"

    - condition: "database_connection_pool >= 95%"
      duration: "3m"
      action: "immediate_rollback"
      notification: "critical"

    - condition: "memory_usage >= 90%"
      duration: "5m"
      action: "immediate_rollback"
      notification: "warning"

  manual:
    enabled: true
    authorized_roles:
      - "council-member"
      - "platform-steward"
      - "ops-guardian"
    kill_switch:
      endpoint: "/ops/canary/abort"
      method: "POST"
      auth: "bearer_token"
      confirmation_required: true
      audit_trail: true

  business_rules:
    - condition: "payment_failure_rate > 1%"
      duration: "10m"
      action: "pause_and_alert"
      stakeholders: ["@payments-team", "@council-stewards"]

    - condition: "customer_complaints > 10"
      window: "1h"
      action: "pause_and_review"
      stakeholders: ["@customer-success", "@council-stewards"]

# Rollback Procedure
rollback:
  automatic:
    enabled: true
    trigger_on_abort: true
    method: "instant"  # Options: instant, gradual

  instant_rollback:
    steps:
      - action: "route_all_traffic_to_stable"
        timeout: "30s"

      - action: "stop_canary_pods"
        timeout: "1m"

      - action: "clear_canary_cache"
        timeout: "30s"

      - action: "notify_oncall"
        channels: ["slack", "pagerduty"]

      - action: "create_incident_report"
        template: "canary-failure"

  gradual_rollback:
    phases:
      - traffic_percent: 10
        duration: "5m"
      - traffic_percent: 5
        duration: "5m"
      - traffic_percent: 1
        duration: "5m"
      - traffic_percent: 0
        duration: "immediate"

  verification:
    wait_period: "10m"
    check_metrics:
      - "error_rate < 1%"
      - "p95_latency < 250ms"
      - "no_active_incidents"
    notify_on_success: true

  post_rollback:
    required_actions:
      - "root_cause_analysis"
      - "incident_postmortem"
      - "update_runbook"
      - "communicate_to_team"
    timeline: "within 24h"

# Health Checks
health_checks:
  startup_probe:
    endpoint: "/health/startup"
    initial_delay: "10s"
    period: "5s"
    timeout: "3s"
    failure_threshold: 3

  liveness_probe:
    endpoint: "/health/live"
    period: "10s"
    timeout: "5s"
    failure_threshold: 3

  readiness_probe:
    endpoint: "/health/ready"
    period: "5s"
    timeout: "3s"
    failure_threshold: 2
    success_threshold: 2

  custom_health_checks:
    - name: "database_connectivity"
      endpoint: "/health/db"
      critical: true

    - name: "external_api_connectivity"
      endpoint: "/health/external"
      critical: false

    - name: "cache_availability"
      endpoint: "/health/cache"
      critical: false

    - name: "payment_gateway_connection"
      endpoint: "/health/payments"
      critical: true

# Customer Communications
communications:
  customer_notice:
    required_for:
      - "breaking_changes"
      - "ui_redesign"
      - "feature_deprecation"
      - "performance_degradation"

    not_required_for:
      - "bug_fixes"
      - "performance_improvements"
      - "internal_refactoring"
      - "security_patches"

  templates:
    scheduled_maintenance:
      title: "Scheduled System Maintenance"
      message: |
        We're deploying improvements to enhance your experience.
        You may notice brief performance fluctuations.
        No action required on your part.
      channels: ["email", "in-app"]
      advance_notice: "24h"

    feature_rollout:
      title: "New Feature Available"
      message: |
        We're gradually rolling out [FEATURE_NAME] to all users.
        You may see this feature appear in the coming hours.
      channels: ["in-app", "blog"]
      advance_notice: "1h"

    incident_notification:
      title: "Service Degradation Detected"
      message: |
        We've detected an issue and are working to resolve it.
        Your data is safe. Updates will be posted every 30 minutes.
      channels: ["status-page", "twitter", "email"]
      immediate: true

  status_page:
    enabled: true
    url: "https://status.codexdominion.app"
    auto_update: true
    update_frequency: "5m"
    components:
      - "Frontend Application"
      - "Backend API"
      - "Payment Processing"
      - "Database"
      - "Authentication"

  stakeholder_notifications:
    internal:
      - role: "council-stewards"
        events: ["canary_start", "phase_change", "abort", "success"]

      - role: "engineering-team"
        events: ["canary_start", "abort", "success"]

      - role: "customer-success"
        events: ["abort", "customer_impact"]

    external:
      - stakeholder: "premium_customers"
        events: ["breaking_changes", "major_incidents"]
        advance_notice: "48h"

      - stakeholder: "enterprise_clients"
        events: ["all_changes"]
        advance_notice: "72h"

# Pre-Deployment Checklist
pre_deployment:
  required_approvals:
    low_tier:
      - "ci_tests_pass"
      - "lint_checks_pass"

    medium_tier:
      - "ci_tests_pass"
      - "integration_tests_pass"
      - "security_scan_pass"
      - "steward_approval"

    high_tier:
      - "ci_tests_pass"
      - "integration_tests_pass"
      - "e2e_tests_pass"
      - "security_scan_pass"
      - "compliance_review"
      - "council_approval:2"
      - "rollback_plan_documented"

  infrastructure:
    - "canary_environment_ready"
    - "monitoring_dashboards_configured"
    - "alert_rules_active"
    - "rollback_procedure_tested"
    - "oncall_engineer_notified"

  communications:
    - "stakeholders_notified"
    - "status_page_updated"
    - "customer_notice_sent (if required)"

  backups:
    - "database_backup_verified"
    - "configuration_backup_created"
    - "artifact_registry_snapshot"

# Post-Deployment Validation
post_deployment:
  smoke_tests:
    - name: "Homepage loads"
      url: "https://codexdominion.app"
      expected_status: 200
      timeout: "5s"

    - name: "API health check"
      url: "https://api.codexdominion.app/health"
      expected_status: 200
      expected_body: '{"status": "healthy"}'
      timeout: "3s"

    - name: "Authentication flow"
      url: "https://api.codexdominion.app/auth/verify"
      expected_status: 200
      requires_auth: true
      timeout: "5s"

    - name: "Payment gateway connection"
      url: "https://api.codexdominion.app/payments/status"
      expected_status: 200
      timeout: "5s"

  functional_tests:
    - "user_signup_flow"
    - "user_login_flow"
    - "checkout_process"
    - "avatar_management"
    - "api_token_generation"

  performance_validation:
    duration: "30m"
    metrics:
      - "p95_latency <= baseline + 10%"
      - "error_rate <= 0.5%"
      - "throughput >= baseline - 5%"

  monitoring:
    duration: "2h"
    check_intervals: "5m"
    auto_promote_if_healthy: true

# Observability Integration
observability:
  tracing:
    enabled: true
    sample_rate: 100  # percent during canary
    retention: "7d"
    tools:
      - "jaeger"
      - "opentelemetry"

  logging:
    level: "INFO"
    canary_log_level: "DEBUG"  # More verbose during canary
    structured: true
    include_trace_id: true

  dashboards:
    - name: "Canary Overview"
      url: "https://grafana.codexdominion.app/d/canary"
      panels:
        - "Traffic Distribution"
        - "Error Rate Comparison"
        - "Latency Percentiles"
        - "Conversion Funnel"

    - name: "Business Metrics"
      url: "https://grafana.codexdominion.app/d/business"
      panels:
        - "Revenue per User"
        - "Payment Success Rate"
        - "Customer Satisfaction"

  alerts:
    channels:
      - type: "slack"
        webhook: "${SLACK_WEBHOOK_URL}"
        channel: "#codex-alerts"

      - type: "pagerduty"
        integration_key: "${PAGERDUTY_KEY}"
        severity: "critical"

      - type: "email"
        recipients: ["oncall@codexdominion.app"]

# Governance Integration
governance:
  tier_enforcement: true
  requires_sign_off: true
  audit_trail: true

  approval_workflow:
    low_tier:
      auto_deploy: true
      notification_only: true

    medium_tier:
      requires_approval: true
      approvers: ["steward"]
      timeout: "24h"

    high_tier:
      requires_approval: true
      approvers: ["council:2"]
      compliance_check: true
      security_review: true
      timeout: "72h"

  compliance:
    - "performance_budget_p95_300ms"
    - "error_budget_5pct_24h"
    - "test_coverage_80pct"
    - "security_scan_pass"

  post_deployment:
    - "update_deployment_status_md"
    - "create_changelog_entry"
    - "notify_stakeholders"
    - "archive_metrics"
