apiVersion: 1

groups:
  - name: Codex Dominion Alerts
    interval: 30s
    rules:
      - uid: success-rate-alert
        title: Low Success Rate
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: sum(rate(http_requests_total{code!~"5.."}[1m])) / sum(rate(http_requests_total[1m]))
              format: time_series
              interval: ''
              intervalFactor: 2
              legendFormat: 'Success Rate'
              step: 10
        conditions:
          - evaluator:
              type: lt
              params: [0.95]
            operator:
              type: and
            reducer:
              type: last
            type: query
        notifications:
          - uid: slack-notifier
          - uid: teams-notifier

      - uid: latency-alert
        title: High Latency
        condition: C
        data:
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le))
              format: time_series
              legendFormat: 'Latency'
        conditions:
          - evaluator:
              type: gt
              params: [0.5]
            operator:
              type: and
            reducer:
              type: last
            type: query
        notifications:
          - uid: slack-notifier
          - uid: teams-notifier

      - uid: rollback-alert
        title: Rollback Detected
        condition: C
        data:
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: increase(argo_rollouts_rollback_count[10m])
              format: time_series
              legendFormat: 'Rollbacks'
        conditions:
          - evaluator:
              type: gt
              params: [0]
            operator:
              type: and
            reducer:
              type: last
            type: query
        notifications:
          - uid: slack-notifier
          - uid: teams-notifier
