# ============================================
# CodexDominion.app - Multi-Cloud Production
# IONOS Deployment Configuration
# ============================================
version: '3.8'

services:
  # ============================================
  # Main Dashboard
  # ============================================
  dashboard:
    image: jmerritt48/codex-dashboard:latest
    container_name: codex-dashboard
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DOMAIN=codexdominion.app
      - API_URL=http://api:8080
      - AZURE_AI_ENDPOINT=https://jermaine-ai.codexdominion.app
    volumes:
      - ./data/dashboard:/app/data
      - ./logs/dashboard:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - codex-network

  # ============================================
  # API Gateway
  # ============================================
  api-gateway:
    image: jmerritt48/codex-api:latest
    container_name: codex-api
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - NODE_ENV=production
      - API_KEY=${API_KEY}
      - AZURE_ENDPOINT=https://jermaine-ai.codexdominion.app
      - IONOS_ENDPOINT=http://localhost
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=${DATABASE_URL}
    volumes:
      - ./data/api:/app/data
      - ./logs/api:/app/logs
    depends_on:
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - codex-network

  # ============================================
  # Stock Analytics Platform
  # ============================================
  stockanalytics:
    image: jmerritt48/stock-analytics:latest
    container_name: stock-analytics
    restart: unless-stopped
    ports:
      - "8515:8515"
    environment:
      - STREAMLIT_SERVER_PORT=8515
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
      - STREAMLIT_SERVER_HEADLESS=true
      - ALPHA_VANTAGE_KEY=${ALPHA_VANTAGE_KEY}
      - POLYGON_API_KEY=${POLYGON_API_KEY}
    volumes:
      - ./data/stocks:/app/data
      - ./logs/stockanalytics:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8515/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - codex-network

  # ============================================
  # Data Analytics Platform
  # ============================================
  analytics:
    image: jmerritt48/data-analytics:latest
    container_name: data-analytics
    restart: unless-stopped
    ports:
      - "8516:8516"
    environment:
      - STREAMLIT_SERVER_PORT=8516
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
      - STREAMLIT_SERVER_HEADLESS=true
      - DATABASE_URL=${DATABASE_URL}
    volumes:
      - ./data/analytics:/app/data
      - ./logs/analytics:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8516/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - codex-network

  # ============================================
  # Redis Cache
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: codex-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - codex-network

  # ============================================
  # PostgreSQL Database (Optional)
  # ============================================
  database:
    image: postgres:16-alpine
    container_name: codex-database
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=codexdominion
      - POSTGRES_USER=codex
      - POSTGRES_PASSWORD=${DATABASE_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./backups:/backups
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U codex"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - codex-network

  # ============================================
  # Monitoring with basic health checks
  # ============================================
  healthcheck:
    image: alpine/curl
    container_name: codex-healthcheck
    restart: unless-stopped
    networks:
      - codex-network
    command: >
      sh -c "
      while :; do
        echo '[HEALTH] Checking CodexDominion Services...'
        curl -f http://dashboard:3000/health || echo 'Dashboard: FAILED'
        curl -f http://api-gateway:8080/health || echo 'API: FAILED'
        curl -f http://stockanalytics:8515/_stcore/health || echo 'Stock Analytics: FAILED'
        curl -f http://analytics:8516/_stcore/health || echo 'Analytics: FAILED'
        sleep 300
      done
      "
    depends_on:
      - dashboard
      - api-gateway
      - stockanalytics
      - analytics

networks:
  codex-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  nginx_logs:
    driver: local
  redis_data:
    driver: local
